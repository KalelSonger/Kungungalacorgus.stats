# Kungungalacorgus.stats - Major Functions Reference

This document describes the core functions that drive the application's main features.

## main.py - Flask Application & Core Logic

### Authentication

**callback()**
- Route: GET /callback
- Handles Spotify OAuth callback after user authorizes the application
- Exchanges authorization code for access/refresh tokens
- Saves tokens to spotify_token.json for persistent authentication
- Redirects user to main application menu
- Purpose: Complete the Spotify OAuth flow and obtain API access

### Background Sync

**sync_recent_plays_background()**
- Scheduled job that runs every 2 minutes automatically
- Fetches recently played tracks from Spotify API (up to 50 tracks)
- Extracts context information (which playlist/album the song was played from)
- Processes each new track through process_and_store_track()
- Uses last_sync.txt to track timestamp and avoid duplicate processing
- Purpose: Continuously monitor and record all listening activity in the background

**process_and_store_track(track, played_at, access_token, context=None)**
- Core processing function for all track plays
- Determines if the play is from a blacklisted playlist by checking context
- Extracts song, artist, and album information from Spotify data
- Fetches additional album details from Spotify API
- Calls database functions to insert/update all records with blacklist flag
- Creates relationships between songs, artists, and albums
- Parameters:
  - track: Spotify track object with song data
  - played_at: Timestamp of when track was played
  - access_token: Spotify API authentication token
  - context: Dict with 'type' and 'uri' indicating playback source (playlist/album)
- Purpose: Central hub for processing and storing all track play data

### Manual Sync

**sync_recent()**
- Route: GET /sync_recent
- Allows user to manually trigger a sync via "Sync Songs" button
- Accepts limit parameter (1-50) for how many recent tracks to fetch
- Processes each track with context detection for blacklist checking
- Redirects to statistics page after completion
- Purpose: Give users control over when to fetch and process recent plays

### Blacklist Management

**add_to_blacklist_route()**
- Route: POST /add_to_blacklist
- Accepts Spotify playlist URL or URI from user input
- Extracts playlist ID from the URL/URI format
- Fetches playlist name and image from Spotify API
- Adds playlist to blacklist.json file
- Returns success/error JSON response
- Purpose: Allow users to add playlists they want excluded from regular statistics

**remove_from_blacklist_route(playlist_id)**
- Route: POST /remove_from_blacklist/<playlist_id>
- Removes specified playlist from blacklist.json
- Returns success/error JSON response
- Purpose: Allow users to remove playlists from the blacklist

---

## database.py - MySQL Database Layer

### Database Initialization

**create_database_if_not_exists()**
- Automatically creates MySQL database and user on first run
- Connects as root user using password from .env file
- Creates spotifyDatabase database if it doesn't exist
- Creates spotify_user and grants all privileges
- Gracefully handles if database/user already exists
- Purpose: Simplify setup by auto-creating database infrastructure

**init_database()**
- Called when application starts
- Runs create_database_if_not_exists() first
- Verifies database connection is working
- Counts and reports number of existing tables
- Purpose: Ensure database is ready before application begins processing data

### Core Data Storage

**insert_or_update_song(song_data)**
- Inserts new song or updates existing song's statistics
- Automatically adds missing columns (last_played, image_url, blacklist columns)
- Increments EITHER regular counters OR blacklisted counters based on is_blacklisted flag
- Regular: S_Listens and S_Listen_Time
- Blacklisted: S_Blacklisted_Listens and S_Blacklisted_Time
- Updates last_played timestamp
- Parameters: song_data dict with id, title, length_ms, played_at, image_url, is_blacklisted
- Purpose: Track individual song play statistics with separate regular/blacklisted counters

**insert_or_update_artist(artist_id, artist_name, song_length_ms, image_url=None, is_blacklisted=False)**
- Inserts new artist or updates existing artist's statistics
- Automatically adds blacklist columns if missing
- Increments EITHER regular OR blacklisted counters based on flag
- Regular: A_Listens and A_Listen_Time
- Blacklisted: A_Blacklisted_Listens and A_Blacklisted_Time
- Aggregates listening time across all songs by this artist
- Purpose: Track artist-level statistics with separate regular/blacklisted counters

**insert_or_update_album(album_id, album_title, total_tracks, album_length_ms, song_length_ms, image_url=None, is_blacklisted=False)**
- Inserts new album or updates existing album's statistics
- Automatically adds blacklist columns if missing
- Increments EITHER regular OR blacklisted counters based on flag
- Tracks total album listening time across all plays
- Purpose: Track album-level statistics with separate regular/blacklisted counters

### Data Retrieval

**get_all_songs()**
- Retrieves all songs from database with full statistics
- Returns: List of dictionaries with id, title, listens, listen_time_ms, blacklisted_listens, blacklisted_time_ms, last_played, image_url
- Purpose: Fetch all song data for Statistics tab display

**get_all_artists()**
- Retrieves all artists that have at least 1 regular (non-blacklisted) listen
- Filters: WHERE A_Listens > 0 (excludes artists with only blacklisted plays)
- Returns: List of dictionaries with id, name, listens, listen_time_ms, blacklisted_listens, blacklisted_time_ms, image_url
- Purpose: Fetch artist data for Top Artists tab (only shows artists with real listening)

**get_all_albums()**
- Retrieves all albums that have at least 1 regular (non-blacklisted) listen
- Filters: WHERE A_Listen_Time > 0 (excludes albums with only blacklisted plays)
- Returns: List of dictionaries with id, title, total_tracks, listens, listen_time_ms, blacklisted_listens, blacklisted_time_ms, image_url
- Purpose: Fetch album data for Top Albums tab (only shows albums with real listening)

### Blacklist Storage

**get_blacklist()**
- Reads blacklist from blacklist.json file
- Returns: List of blacklisted playlist dictionaries with id, name, image_url
- Purpose: Load current blacklist for comparison during track processing

**add_to_blacklist(playlist_id, playlist_name, image_url=None)**
- Adds a playlist to the blacklist
- Prevents duplicate entries
- Saves updated blacklist to blacklist.json
- Purpose: Store blacklisted playlists persistently

**remove_from_blacklist(playlist_id)**
- Removes a playlist from the blacklist
- Saves updated blacklist to blacklist.json
- Purpose: Remove playlists from blacklist

---

## Key System Architecture

### Blacklist System
1. **Context Detection**: When a song is played, Spotify's API provides context (which playlist/album it came from)
2. **Blacklist Checking**: System checks if the context matches any playlist in blacklist.json
3. **Separate Counters**: Each song/artist/album has TWO sets of counters:
   - Regular: For plays from albums, non-blacklisted playlists, search, etc.
   - Blacklisted: For plays from blacklisted playlists only
4. **Smart Filtering**: Top tabs only show items with regular listens > 0, hiding items with only blacklisted plays
5. **Toggle Visibility**: UI allows users to show/hide blacklisted statistics on demand

### Data Flow
1. User plays song on Spotify
2. Background sync runs every 2 minutes
3. Fetches recently played tracks with context
4. Checks if context matches blacklisted playlist
5. Increments appropriate counters (regular OR blacklisted)
6. Updates database with new statistics
7. UI displays data with optional blacklisted stats visibility

### Database Schema
- **Songs Table**: Individual track records with S_Listens, S_Listen_Time, S_Blacklisted_Listens, S_Blacklisted_Time
- **Artists Table**: Artist records with A_Listens, A_Listen_Time, A_Blacklisted_Listens, A_Blacklisted_Time
- **Albums Table**: Album records with similar blacklist column pattern
- **Relationship Tables**: Track which songs belong to which artists/albums/playlists

